@page "/category/{CategoryName}/{HeadingId}/{FriendlyUrl}/"
@page "/category/{CategoryName}/{HeadingId}/{FriendlyUrl}/{PageIndex:int}"
@page "/category/{CategoryName}/{HeadingId}/{FriendlyUrl}/{PageIndex:int}/{PostId:guid}"
@using System.Text.RegularExpressions

@inject IJSRuntime JS
@implements IAsyncDisposable

@inject RefreshStateService refreshStateService;

@if (Heading != null)
{
    <AddBreadcrumb Items="BreadcrumbItems"></AddBreadcrumb>
    <h1 class="heading-title">@Heading.Title</h1>
}

@if(Posts != null)
{
    <Pagination TotalPages="@TotalPages" CurrentPage="@CurrentPage" BaseUrl="@getBaseUrl()" />
    @foreach (var post in Posts)
    {
        @* <PostCard Id="@post.Id.ToString()" Content="@post.Content" Username="@post.UserName"></PostCard> *@
        <MiniPostCard Post="post" 
            Id="@post.Id" 
            PostId="@post.Id" 
            Content="@post.Content" 
            Username="@post.UserName" 
            IsOP='Heading!.UserName == post.UserName' 
            LikeCallback="(postId) => LikePost(postId)"
            UnLikeCallback="(postId) => UnLikePost(postId)"
            AddFavoriteCallback="(postId) => AddFavorite(postId)"
            OpenChatCallback="(postId) => OpenChatBoxWithUsername(post.UserName)"
            ReplyCallback="(post) => AddReply(post)"></MiniPostCard>
    }
    <Pagination TotalPages="@TotalPages" CurrentPage="@CurrentPage" BaseUrl="@getBaseUrl()" />
    <CreatePostForm @ref=child Model="CreateModel" HeadingId="@HeadingGuid" Callback="RefreshPosts"></CreatePostForm>
}
else
{
    <p>Loading...</p>
}



@code {
    [Parameter]
    public string CategoryName { get; set; }

    [Parameter]
    public string? FriendlyUrl { get; set; }

    [Parameter]
    public string? HeadingId { get; set; }

    private Guid HeadingGuid { get; set; }

    [Parameter]
    public Guid PostId { get; set; }

    [Parameter]
    public int PageIndex { get; set; } = 1;

    [Inject]
    public IPostService PostService { get; set; }

    [Inject]
    public IHeadingService HeadingService { get; set; }

    [Inject]
    public ICategoryService CategoryService { get; set; }

    [Inject]
    public NavigationManager NavigationManager { get; set; }

    [Inject]
    public ILikeService LikeService { get; set; }

    [Inject]
    public IFavoriteService FavoriteService { get; set; }

    [Inject]
    public IUserService UserService { get; set; }

    [Inject]
    public ITrackingLogService? TrackingLogService { get; set; }

    HeadingVM? Heading { get; set; }

    UserInfoVM CurrentUser { get; set; }

    public List<PostVM>? Posts { get; private set; }
    public List<PostVM>? QuotePosts { get; private set; }

    public PostVM CreateModel { get; set; }

    private List<BreadcrumbItem> BreadcrumbItems { get; set; }


    public List<LikeVM>? Likes { get; private set; }
    public List<FavoriteVM>? Favorites { get; private set; }

    [CascadingParameter] private Task<AuthenticationState> authenticationStateTask { get; set; }

    private string getBaseUrl()
    {
        return $"category/{CategoryName}/{HeadingId}/{FriendlyUrl}/";
    }

    // Pagination variables
    private int PageSize = 10; // Number of items per page
    private int TotalPages = 1;
    private int CurrentPage = 1;

    private IJSInProcessObjectReference? module;

    private string? CurrentUsername { get; set; }

    CreatePostForm child;

    protected async Task SetBreadcrumb()
    {
        var parentCategories = await CategoryService.GetParentCategoriesByName(CategoryName);
        parentCategories = parentCategories.OrderBy(x => x.Id).ToList();

        BreadcrumbItems = new List<BreadcrumbItem>();
        BreadcrumbItems.Add(new BreadcrumbItem { Text = "Homepage", HrefLink = $"/" });
        foreach (var parent in parentCategories)
        {
            BreadcrumbItems.Add(new BreadcrumbItem { Text = parent.Name, HrefLink = $"/category/{parent.Name}/" });
        }
        BreadcrumbItems.Add(new BreadcrumbItem { Text = Heading!.Title, IsCurrentPage = true });
    }

    private void SetFavorites()
    {
        if (Posts == null || Favorites == null)
            return;

        foreach (var post in Posts)
        {
            var favorite = Favorites.FirstOrDefault(x => x.PostId == post.Id && x.UserName == CurrentUsername);

            if(favorite != null)
            {
                post.IsFavorite = true;
            }
            else
            {
                post.IsFavorite = false;
            }
        }
    }

    private void SetLikes()
    {
        if (Posts == null || Likes == null)
            return;

        foreach (var post in Posts)
        {
            post.LikeCounter = Likes.Where(x => x.PostId == post.Id && x.IsLike == true).Count();
            post.UnlikeCounter = Likes.Where(x => x.PostId == post.Id && x.IsLike == false).Count();
            var like = Likes.FirstOrDefault(x => x.PostId == post.Id && x.UserName == CurrentUsername);
            if(like != null)
            {
                post.IsLike = like.IsLike;
            }
            else
            {
                post.IsLike = null;
            }
        }
    }


    protected async override Task OnInitializedAsync()
    {
        var cookiePolicyAccepted = await JS.InvokeAsync<string>("GetCookiePolicyAccepted");

        if (TrackingLogService is not null && HeadingId is not null && cookiePolicyAccepted == "true")
        {
            module = await JS.InvokeAsync<IJSInProcessObjectReference>("import", "./Pages/Headings/HeadingDetail.razor.js");

            AddTrackingLogCommandVM command = new AddTrackingLogCommandVM
            {
                Type = Models.Enums.TrackingTypeVM.HEADING,
                TargetId = HeadingId.DecodeBase64UrlToGuid(),
                URL = getBaseUrl(),
                Browser = await module.InvokeAsync<string>("GetBrowserName")
            };

            await TrackingLogService.AddTrackingLog(command);
        }
    }


    protected async override Task OnParametersSetAsync()
    {
        CreateModel = new PostVM();

        if (PageIndex == 0) PageIndex = 1;

        var authState = await authenticationStateTask;
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            CurrentUsername = user.Identity.Name;
        }

        CurrentPage = PageIndex;

        HeadingGuid = HeadingId.DecodeBase64UrlToGuid();

        Heading = await HeadingService.GetHeadingById(HeadingGuid);
        PostsPaginationVM postPagination = await PostService.GetPostsByHeadingIdWithPagination(HeadingGuid, PageIndex, PageSize);
        Posts = postPagination.Posts;
        QuotePosts = postPagination.QuotePosts;

        ConfigureDisplayPosts(Posts);

        Likes = await LikeService.GetLikesByHeadingId(HeadingGuid);

        if(CurrentUsername != null)
        {
            Favorites = await FavoriteService.GetFavoritesByHeadingIdAndUserName(HeadingGuid, CurrentUsername);
        }

        SetLikes();
        SetFavorites();

        await ScrollToEntry();
        TotalPages = (int)Math.Ceiling((double)postPagination.TotalCount / PageSize);

        await SetBreadcrumb();

        await InvokeAsync(StateHasChanged);
    }

    private void ConfigureDisplayPosts(List<PostVM>? posts)
    {
        if (posts == null) return;
        if (posts.Count == 0) return;

        foreach (var post in posts)
        {
            post.DisplayContent = GenerateDisplayContent(post.Content);
        }
    }

    private string GenerateDisplayContent(string content)
    {
        string displayContent = content;

        // Regex quoteRegex = new Regex(@"\[Quote\]\(PostId=(\d+)\)\[\/Quote\]");
        Regex quoteRegex = new Regex(@"\[Quote\]\(PostId=([0-9a-fA-F-]{36})\)\[\/Quote\]");
        MatchCollection matches = quoteRegex.Matches(displayContent);

        foreach (Match match in matches)
        {
            Guid postId = new Guid(match.Groups[1].Value);

            string quoteContent = "- Removed -";
            PostVM? quotePost;

            if(QuotePosts != null && QuotePosts.Count() > 0)
            {
                quotePost = QuotePosts.FirstOrDefault(x => x.Id == postId);

                if(quotePost != null)
                {
                    quoteContent = DeleteQuoteTagsInQuote(quotePost.Content);
                }
            }

            string newTag = $"<blockquote author-quote='Alıntı' post-id='{postId}' class='quote-box'>{quoteContent}</blockquote>";

            displayContent = displayContent.Replace(match.Value, newTag);
        }

        return displayContent;
    }

    private async Task ScrollToEntry()
    {
        StateHasChanged();
        await JSRun();
    }

    protected async Task JSRun()
    {
        if (!string.IsNullOrEmpty(PostId.ToString()))
        {
            module = await JS.InvokeAsync<IJSInProcessObjectReference>("import", "./Pages/Headings/HeadingDetail.razor.js");
            await module.InvokeAsync<string>("BlazorScrollToId", PostId);
        }
    }

    protected async Task RefreshPosts()
    {
        PostsPaginationVM postPagination = await PostService.GetPostsByHeadingIdWithPagination(HeadingGuid, 1, PageSize);
        Posts = postPagination.Posts;
        QuotePosts = postPagination.QuotePosts;

        ConfigureDisplayPosts(Posts);
        await ScrollToEntry();
        TotalPages = (int)Math.Ceiling((double)postPagination.TotalCount / PageSize);
        await InvokeAsync(StateHasChanged);
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (module is not null)
        {
            await module.DisposeAsync();
        }
    }

    protected async Task LikePost(Guid PostId)
    {
        LikeVM newLike = new LikeVM
        {
            PostId = PostId,
            HeadingId = Heading!.Id,
            IsLike = true
        };

        var post = Posts.FirstOrDefault(x => x.Id == PostId);

        if (post != null)
        {
            if (post.IsLike == true)
            {
                post.IsLike = null;
                post.LikeCounter--;
            }
            else if(post.IsLike == false)
            {
                post.IsLike = true;
                post.LikeCounter++;
                post.UnlikeCounter--;
            }
            else if(post.IsLike == null)
            {
                post.IsLike = true;
                post.LikeCounter++;
            }

        }
        await InvokeAsync(StateHasChanged);

        await LikeService.AddLike(newLike);
    }

    protected async Task UnLikePost(Guid PostId)
    {
        LikeVM newLike = new LikeVM
        {
            PostId = PostId,
            HeadingId = Heading!.Id,
            IsLike = false
        };

        var post = Posts.FirstOrDefault(x => x.Id == PostId);

        if (post != null)
        {
            if(post.IsLike == false)
            {
                post.IsLike = null;
                post.UnlikeCounter--;
            }
            else if (post.IsLike == true)
            {
                post.IsLike = false;
                post.UnlikeCounter++;
                post.LikeCounter--;
            }
            else if (post.IsLike == null)
            {
                post.IsLike = false;
                post.UnlikeCounter++;
            }
        }
        await InvokeAsync(StateHasChanged);

        await LikeService.AddLike(newLike);
    }

    protected async Task AddFavorite(Guid PostId)
    {
        FavoriteVM newFavorite = new FavoriteVM
        {
            PostId = PostId,
            HeadingId = Heading!.Id,
        };

        var post = Posts.FirstOrDefault(x => x.Id == PostId);

        if(post != null)
        {
            post.IsFavorite = !post.IsFavorite;
        }

        await InvokeAsync(StateHasChanged);
        await FavoriteService.AddFavorite(newFavorite);
    }

    protected async Task OpenChatBoxWithUsername(string userName)
    {
        if (refreshStateService != null)
        {
            await refreshStateService.OpenChatBox!.Invoke(userName);
        }
    }

    protected async Task AddReply(PostVM post)
    {
        CreateModel.Content += $"\n[Quote](PostId={post.Id})[/Quote]";

        // var postContent = await PostService.Get
        string handledPost = DeleteQuoteTagsInQuote(post.Content);
        CreateModel.DisplayContent += $"\n<blockquote author-quote='Alıntı' post-id='{post.Id}' class='quote-box'>{handledPost}</blockquote>\n<div>reply..</div>";

        await child.SetContenteditable();
        await InvokeAsync(StateHasChanged);
    }


    private string DeleteQuoteTagsInQuote(string content)
    {
        string newContent = content;

        // Regex quoteRegex = new Regex(@"\[Quote\]\(PostId=(\d+)\)\[\/Quote\]");
        Regex quoteRegex = new Regex(@"\[Quote\]\(PostId=([0-9a-fA-F-]{36})\)\[\/Quote\]");
        Regex quoteRegex4 = new Regex(@"<blockquote\s+author-quote=['""]([^'""]*)['""]\s+post-id=['""]([0-9a-fA-F-]{36})['""]\s+class=['""]quote-box['""]>([\s\S]*?)<\/blockquote>");
        // Regex quoteRegex4 = new Regex(@"<blockquote\s+author-quote=['""]([^'""]*)['""]\s+post-id=['""](\d+)['""]\s+class=['""]quote-box['""]>([\s\S]*?)<\/blockquote>");
        MatchCollection matches = quoteRegex.Matches(newContent);
        MatchCollection matches4 = quoteRegex4.Matches(newContent);

        foreach (Match match in matches)
        {
            string postId = match.Groups[1].Value;

            newContent = newContent.Replace(match.Value, string.Empty);
        }

        foreach (Match match in matches4)
        {
            string postId = match.Groups[1].Value;

            newContent = newContent.Replace(match.Value, string.Empty);
        }

        return newContent;
    }


}