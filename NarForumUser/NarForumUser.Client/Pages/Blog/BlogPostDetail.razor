@page "/blog/{Title}-{BlogPostId:int}"

@using NarForumUser.Client.Models.BlogPost
@using NarForumUser.Client.Pages.Blog.Component
@using System.Text.RegularExpressions
@inject IConfiguration Configuration
@if (BlogPostVM is not null)
{
    <MetaTags 
        PageTitle="@BlogPostVM.Title"
        PageDescription="@ArrangeContent(BlogPostVM.Content)"
        ContentType="article"
        PostTitle="@Configuration["SiteName"]"
        CanonicalUrl="@($"{Configuration["BaseUrl"]}/blog/{Title}-{BlogPostId}")" />

    <AddBreadcrumb Items="BreadcrumbItems"></AddBreadcrumb>

    <div class="col-sm-12 blog-post-detail-container">
        <h1 class="blog-post-detail-heading">@BlogPostVM.Title</h1>
        <div class="blog-post-detail-content">
            @((MarkupString)BlogPostVM.Content)
        </div>
    </div>

    <BlogCommentList BlogPostVM="BlogPostVM"></BlogCommentList>
} else
{
    <SkeletonBreadcrumb></SkeletonBreadcrumb>
    <div class="col-sm-12 blog-post-detail-container">
        <SkeletonH1 ClassName="blog-post-detail-heading"></SkeletonH1>
        <div class="blog-post-detail-content">
            <SkeletonText></SkeletonText>
            <SkeletonText></SkeletonText>
            <SkeletonText></SkeletonText>
            <SkeletonText></SkeletonText>
            <SkeletonText></SkeletonText>
            <SkeletonText></SkeletonText>
        </div>
    </div>
}

@code {
    [Inject]
    private IBlogPostService? blogPostService { get; set; }

    [Parameter]
    public BlogPostVM? BlogPostVM { get; set; }

    [Parameter]
    public string? Title { get; set; }

    [Parameter]
    public int BlogPostId { get; set; }

    private List<BreadcrumbItem> BreadcrumbItems { get; set; }

    [Inject]
    public IJSRuntime JS { get; set; }

    [Inject]
    public ITrackingLogService? TrackingLogService { get; set; }

    protected async Task SetBreadcrumb()
    {
        BreadcrumbItems = new List<BreadcrumbItem>();
        BreadcrumbItems.Add(new BreadcrumbItem { Text = "Blog", HrefLink = $"/blog" });
        if(BlogPostVM.BlogCategory is not null)
        {
            BreadcrumbItems.Add(new BreadcrumbItem { Text = $"{BlogPostVM.BlogCategory.Name}", HrefLink = $"/blog/{BlogPostVM.BlogCategory.Name.ToFriendlyUrl()}" });
        }
        else
        {
            BreadcrumbItems.Add(new BreadcrumbItem { Text = $"No Category", HrefLink = null });
        }
        BreadcrumbItems.Add(new BreadcrumbItem { Text = $"{BlogPostVM.Title}", IsCurrentPage = true });
    }

    protected async override Task OnParametersSetAsync()
    {
        if (BlogPostVM is null && blogPostService is not null)
        {
            var query = new GetBlogPostQueryVM
            {
                IntId = BlogPostId
            };

            BlogPostVM = await blogPostService.GetBlogPost(query);


            await SetBreadcrumb();
            await SaveTrackingLog();
        }

        await base.OnParametersSetAsync();
    }

    private async Task SaveTrackingLog()
    {
        if (JS is not IJSInProcessRuntime)
        {
            return;
        }

        var cookiePolicyAccepted = await JS.InvokeAsync<string>("GetCookiePolicyAccepted");

        if (TrackingLogService is not null && cookiePolicyAccepted == "true")
        {
            AddTrackingLogCommandVM command = new AddTrackingLogCommandVM
                {
                    Type = Models.Enums.TrackingTypeVM.BLOG,
                    URL = $"/blog/{Title}-{BlogPostId}",
                    TargetId = BlogPostVM is not null ? BlogPostVM.Id : null,
                    DateTime = DateTime.UtcNow,
                    IsMember = true,
                    Browser = await JS.InvokeAsync<string>("GetBrowserName")
                };

            await TrackingLogService.AddTrackingLog(command);
        }
    }

    public string ArrangeContent(string content)
    {
        string textOnly = Regex.Replace(content, "<.*?>", String.Empty);
        return textOnly;
    }
}